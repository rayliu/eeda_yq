package controllers.profile.mailConfig;import interceptor.EedaMenuInterceptor;import interceptor.SetAttrLoginUserInterceptor;import java.io.File;import java.util.Collections;import java.util.Date;import java.util.List;import models.Office;import models.UserLogin;import models.eeda.oms.jobOrder.JobOrderSendMail;import org.apache.commons.lang.StringUtils;import org.apache.commons.mail.DefaultAuthenticator;import org.apache.commons.mail.EmailAttachment;import org.apache.commons.mail.MultiPartEmail;import org.apache.shiro.authz.annotation.RequiresAuthentication;import sun.misc.BASE64Encoder;import com.jfinal.aop.Before;import com.jfinal.core.Controller;import com.jfinal.kit.StrKit;import com.jfinal.log.Log;import com.jfinal.plugin.activerecord.Db;import com.jfinal.plugin.activerecord.Record;import controllers.profile.LoginUserController;@RequiresAuthentication@Before(SetAttrLoginUserInterceptor.class)public class MailConfigController extends Controller {    private Log logger = Log.getLog(MailConfigController.class);    @Before(EedaMenuInterceptor.class)    public void index() {        UserLogin user = LoginUserController.getLoginUser(this);        long officeId = user.getLong("office_id");        Office o = Office.dao.findById(officeId);        setAttr("office", o);        render("/eeda/profile/mailConfig/edit.html");    }    public void save(){        String officeId = getPara("officeId");        String smtp = getPara("smtp");        String smtpPort = getPara("smtpPort");        String userName = getPara("userName");        String userPwd = getPara("userPwd");        Office o = Office.dao.findById(officeId);        if(o!=null){            o.set("email_login_name", userName);            o.set("email_login_pwd", userPwd);            o.set("email_smtp_host", smtp);            o.set("smtp_port", smtpPort);            o.update();        }        renderText("OK");    }    public void sendMail() throws Exception {        String officeId = getPara("officeId");        Office o = Office.dao.findById(officeId);                MultiPartEmail email = new MultiPartEmail();          /*smtp.exmail.qq.com*/        email.setHostName(o.getStr("email_smtp_host"));        email.setSmtpPort(o.getInt("smtp_port"));                /*输入公司的邮箱和密码*/        String userName = o.getStr("email_login_name");        String userPwd = o.getStr("email_login_pwd");        email.setAuthenticator(new DefaultAuthenticator(userName, userPwd));                email.setSSLOnConnect(true);        email.setFrom(userName, "测试");//设置发信人        //设置收件人，邮件标题，邮件内容        email.addTo(userName);        email.setSubject("邮箱设置测试邮件");        email.setMsg("邮箱设置测试邮件");                try{            email.setCharset("UTF-8");             email.send();            JobOrderSendMail jsm = new JobOrderSendMail();            jsm.set("mail_title", "邮箱设置测试邮件");            jsm.set("receive_mail", userName);            jsm.set("sender", LoginUserController.getLoginUserName(this));            jsm.set("send_time", new Date());            jsm.save();            renderText("OK");        }catch(Exception e){            e.printStackTrace();            renderText("failed");        }    }}